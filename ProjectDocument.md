# 医疗数据区块链存储服务

Medical Data Blockchain Services Platform

本申请设计软件技术领域，尤其涉及一种基于区块链技术的分布式网络医疗数据加密存储、共享和管理系统。

## 摘要

本发明属于软件技术领域，公开一种基于区块链平台存储医疗数据的系统架构及对应的设计方法。基于区块链数据存储实现数据保密、数据共享和数据防止篡改的功能。根据区块链公链和联盟链的特性组织分为院方组织、普通用户组织、可信任认证组织、公链组织和后台管理组织共五个主要部分。采用验证Hash值和验证证书的方式读取写入数据，并且采取隐藏用户ID和Hash值的方式进行数据传输，可以保护普通用户医疗数据隐私。采用区块链技术进行信息存储，可以防止数据的恶意篡改。组织采用分布式信息存储，可以提高信息访问的效率，节约医疗数据读取的时间。采用多种数据存储方式，确保重要信息优先快速传输，并且确保全部完整信息保存。查询修改写入均对应记录到公链，对普通用户进行通知，普通用户有权停止其访问操作，以降低数据被恶意读取的风险。

## 主要组织与组织权限

### 院方组织

院方组织包括院方医务人员节点、服务管理节点、多媒体文件备份节点和区块链服务节点。医务人员节点具有普通用户数据读取权限和普通用户数据写入权限；服务管理节点具有智能合约服务管理请求权限、组织节点管理权限和账号校验权限；多媒体文件备份节点具有数据读取权限和数据写入权限；区块链服务节点具有交易背书权限。

### 普通用户组织

普通用户组织包括普通用户节点、服务管理节点、多媒体文件备份节点和区块链服务节点。普通用户节点具有用户数据读取权限和院方节点合法性校验的权限；服务管理节点具有智能合约服务管理请求权限、组织节点管理权限和账号校验权限；多媒体文件备份节点具有数据读取权限和数据写入权限；区块链服务节点具有交易背书权限。

### 可信任认证组织

可信任认证组织，以下简称认证组织。认证组织包括认证组织管理节点和认证组织查询节点。认证组织管理节点具有普通用户认证注册服务权限、普通用户账户校验服务权限、普通用户账户注销服务权限、普通用户组织创建权限、院方医务人员认证注册服务权限、院方医务人员管理权限、院方医务人员账户校验服务权限和院方组织创建权限；认证组织查询节点具有读取加密医疗数据的权限。

### 公链服务组织

公链服务组织包括公链管理服务节点、公链查询服务节点和公链校验服务节点。公链管理服务节点具有写入公链普通用户ID权限、写入公链普通用户Hash权限、写入公链医务人员ID权限、修改医务人员当前状态权限、写入公链查询记录链权限和写入公链写入记录链权限；公链查询服务节点具有读取普通用户医疗数据权限；公链校验服务节点具有读取校验普通用户Hash权限、读取校验院方医务人员Hash权限。

### 后台管理服务组织

后台管理服务组织包括普通用户组织管理节点、院方医务人员管理组织节点和认证组织管理节点。普通用户组织管理节点具有普通用户节点管理权限和普通用户组织智能合约管理权限；院方医务人员管理组织节点具有院方医务人员节点管理权限和院方组织智能合约管理权限；认证组织管理节点具有认证组织节点管理权限和认证组织账号权限管理。

### 主要权限设置

| Organization     | Authority                                         |
| ---------------- | ------------------------------------------------- |
| 院方节点         | 写入用户医疗数据、读取用户医疗数据                |
| 普通用户节点     | 读取个人数据、读取公链查询记录链和写入记录链      |
| 认证组织管理节点 | 写入用户ID/修改用户状态、创建组织/用户            |
| 认证组织查询节点 | 读取加密数据（对公数据）                          |
| 后台管理服务节点 | 读取/写入公链验证信息、调取用户数据、智能合约管理 |

## 用户ID信息与院方信息记录

认证的可信任组织可以创建新的用户ID，并且调用医学数据区块链存储服务为对应的普通用户在指定的用户组织中创建新的普通用户节点，由医学数据区块链存储服务维护公链中用户Hash链。认证的可信任组织可以同样创建院方节点，并调用医学数据区块链存储服务在对应的院方组织中创建新的节点，主链的院方Hash由医学数据区块链存储服务维护。院方组织内部的Hash链在组织通道内维护。

## 数据设计

根据区块链平台的架构设计，利用联盟链的多链特点对数据进行结构设计，数据存储分为三个部分，存储数据、输出数据和查找验证数据。存储数据分为主要数据（包括全部文字数据和影像数据的Hash摘要）、摘要数据（重要文字数据和Hash摘要）和影像数据；数据输出需要根据不同场景的需求设计，包括面向普通用户数据、面向院方数据和对公数据；查找和验证数据（主链数据）。

### 存储数据

存储数据部分分为主要数据、摘要数据和影像数据三个部分。主要数据和影像数据设计在院际组织和普通用户组织内分别设计通道进行数据存储广播背书，院方对普通用户的数据没有修改写入权限，普通用户没有修改写入权限，确保数据不易被篡改；而影像数据部分，采取云端备份的方法进行存储，在院方组织和普通用户组织内均进行数据备份，读取时，使用Hash摘要进行验证读取。

1. 主要数据：存储全部的医疗数据和病例数据，提供相对完全且准确的数据记录。由于区块链存储数据量较大，将影像等占据存储空间较大的数据进行Hash摘要存储，以备调取对应数据时进行正确性验证。数据在院方组织和普通用户组织均进行背书。
2. 摘要数据：根据医学院同学提供的数据重要程度列表对院方节点提供的数据进行筛选，将重要指标数据和其他数据的Hash摘要以JSON键值对的形式进行存储，以备调取数据时进行正确性验证。数据在院方组织和普通用户组织均进行背书。
3. 影像数据：存储全部的医疗数据、病例数据和影像数据，提供最全面的相对准确的数据记录，信息的安全级别相对低。数据在院方提交节点、院方特定的备份节点首先进行备份，然后将数据由医疗数据区块链存储服务传输给普通用户组织，在普通用户组织内由对应的普通用户和该组织的特定备份节点备份。

### 输出数据

输出数据部分分为普通用户数据、院方数据和对公数据三个部分，这一部分的数据和存储数据是一致的，针对于不同的需求进行读取。

1. 普通用户数据：对应的用户节点进行本地读取，将时间戳、对应院方Hash、病例内容通过在主链的查找验证Hash后转化为可读性内容，经由医疗数据区块链存储服务传输给用户客户端。
2. 院方数据：根据用户提供的信息，经由医疗数据区块链存储服务在主链进行查找验证找到对应的普通用户节点，优先读取对应的主要数据，经过主链Hash验证后将结果返回给院方客户端。由医疗数据区块链存储服务提供临时连接，以便加快读取效率，为后期读取其他数据提供途径。
3. 对公数据：对其他组织进行数据统计等工作提供的数据，这些数据是匿名的，且只提供关键数据的读取，除需要统计的医疗数据以外，其他数据均以加密形式提供。

### 查找和验证数据

在程序的设计中，主链上存储普通用户的Hash验证。主链分为用户ID链、用户Hash琏、查询记录链、写入记录链和院方Hash链，主要提供信息验证的作用。

1. 用户ID链：通过已通过认证的可信任组织将用户提供的ID转化为加密的Hash ID，存储在一条公共链上，在院方调取患者数据的时候，首先将患者提供的ID经过医疗数据区块链存储服务在主链上查找对应的Hash ID，服务将根据对应的ID中的组织信息找到患者对应的组织，以便读取数据，确保数据读取过程保密，对应的读取操作将会写入主链的查询记录链，记录信息读取记录，降低恶意读取数据行为的发生风险。
2. 用户Hash链：在每次更新过普通用户的医疗数据信息后，将时间戳、院方数据Hash和普通用户对应的数据Hash进行记录，确保在信息读取时的准确性。普通用户节点的当前状态与用户Hash链的用户数据Hash同步。
3. 查询记录链：记录时间戳、院方信息、普通用户Hash ID、查询信息的相关Hash信息。
4. 写入记录链：记录时间戳、院方信息、普通用户Hash ID、写入或修改信息的相关Hash信息。
5. 院方Hash链：记录服务内所有院方节点的ID，其当前状态定义为其是否具有写入数据的权限，在信息写入时先验证提请节点的当前状态是否允许其进行写入操作。

## 用户认证注册与账号修改与注销

### 普通用户注册

普通用户通过客户端提交信息申请注册，由服务器向普通用户服务器提交申请，普通用户服务器传送当前组织信息数据信息到认证组织服务器，认证组织进行账号注册并在普通用户服务器创建普通用户节点，向公链服务提交用户信息并将用户ID对应计算得到的Hash ID添加到公链用户ID链，将用户的当前状态进行记录，Hash计算后写入公链中的用户Hash链，向客户端不会返回用户Hash ID，仅返回当前普通用户在普通用户组织内的区块链认证证书。用户组织服务器向客户端发放登录证书，区块链证书不向客户端发放。

### 院方医务人员注册

院方医务人员通过客户端提交信息申请注册，由服务器向院方服务器提交申请，院方服务器传送当前组织信息数据信息到认证组织服务器，认证组织进行账号注册并在对应的院方服务器中创建普通用户节点，向公链服务提交院方医务人员信息并添加到院方Hash链，向客户端返回医务人员的区块链认证证书。院方服务器向客户端发放登录证书，区块链证书不向客户端发放。

### 普通用户账号修改与注销

#### 普通用户信息修改

当普通用户信息有误时，从客户端提交信息修改申请，客户端将修改申请提交至认证组织，认证组织首先验证普通用户的Hash值和证书，认证组织经验证修改信息后，对普通用户组织中对应普通用户的节点信息进行修改，返回客户端修改结果。

#### 普通用户账号注销

当普通用户不再希望使用该服务或无法再使用该服务的时候，为避免数据空间资源浪费，从普通用户客户端申请账号注销。普通用户申请账号注销以后，客户端将向认证组织提交账号注销申请，认证组织首先验证该客户端的Hash和证书，校验完成后，向普通用户客户端发送账号注销的确认消息，经确认后将用户组织内的该结点的当前状态改变为Delete，对应文件服务器备份进行标记，检查该用户组织内是否仍存在用户为非Delete状态，组织为空则清空组织释放资源。

### 院方医务人员修改注销

#### 院方医务人员信息修改

当院方医务人员的信息出现变动时，例如职位变动或者行医资格变动，认证组织将修改对应院方组织的医务人员节点当前状态，并将新的医务人员信息追加到院方Hash链中，标记之前的信息为删除状态。

#### 院方医务人员账号注销

院方医务人员不再从事与医疗相关工作后，不允许其再拥有数据写入权限，此时认证组织将会对公链的院方Hash链进行检索标记该医务人员为删除状态，对院方组织内的医务人员节点进行删除操作。

### 特殊情况

特别地，当普通用户组织内的普通节点数量达到设定上限或者院方组织的医务人员节点达到设定的数量上限时，认证组织将会特别地请求新建组织，以便满足新普通用户注册或者新医务人员注册。

## 登录过程

### 普通用户、院方医务人员、认证组织和后台管理登录客户端

使用账号密码的方式登录，登录后验证本地登录证书文件，校验后可以连接对应的服务器。

### 特殊情况

#### 账户遗失

用户注册的账号采取唯一标识符的方式，例如身份证号码、电话号码和邮箱组合的方式。当密码遗失时，从客户端提交密码重置的申请，由认证组织经过验证后，向用户提供密码修改服务。

#### 登录证书由于误操作删除遗失或客户端更换新设备

登录证书是登录除账号和密码外必备的内容，如果缺少该文件，需要客户端向认证组织提交验证申请，验证使用者身份后重新发放登录证书。

## 数据写入的过程

医学数据区块链存储服务的数据写入权限只提供给医院和其他的可信任机构。对于医院这个主要的部分而言，由医院的设备（节点）提供医疗数据，由医院的医生（节点）提供病例数据，这些数据将会被划分成摘要中提及的三个数据存储的类型。首先进行处理的是主要数据和摘要数据，这个部分数据在医院组织内由数据提供节点提交，在排序节点排序后由背书节点进行广播背书，由公链服务继续处理。公链服务首先查询用户组织，然后将数据传输到普通用户（节点）对应的组织的数据接收节点，由该节点进行数据提交，在排序节点排序后由该组织的背书节点进行广播背书。公链服务读取院方节点写入的数据，将记录写入到主链的写入记录链中。最后向院方组织返回结果，同时服务器给予用户客户端新医疗数据纪录的通知。

特别地，在院方的区块链网络上存储的数据只具有医疗数据和加密处理后的ID值，仅供给用于医学研究等工作。

## 数据输出的过程

根据提供的ID信息，由医学数据区块链存储服务在主链上查询对应的组织信息和节点信息，由医学数据区块链存储服务读取数据，根据不同的数据读取请求来源返回数据。

### 用户读取数据

普通用户登录客户端，通过客户端提请数据查询的申请，默认数据查询为查询主要数据，该申请提交到用户组织服务器，用户组织服务器在组织区块链上读取与对应用户相关的信息，校验用户Hash数据Hash后将数据返回给用户客户端。返回的数据不包括用户的ID、Hash值等信息，仅包括医疗数据。如果普通用户需要调取对应的多媒体文件数据，则普通用户登录客户端，通过客户端提请多媒体文件数据查询的申请，用户组织服务器先校验普通用户的证书，校验后寻找对应的文件系统服务器的地址，并向文件系统服务器提交数据查询请求，由文件系统服务器将对应的数据列表传输普通用户至客户端，经普通用户选择需要的资源后文件系统服务器将对应数据传输至客户端。医疗数据优先传输重要的摘要数据，然后按照时间由近及远的次序将主要数据传输，最后文件系统服务器传输多媒体文件医疗数据。不允许普通用户查询其他普通用户的数据。

### 院方读取数据

#### 院方读取院方组织数据

医务人员登录客户端，通过客户端提请数据查询的申请，默认查询主要数据，客户端连接院方节点，院方节点部署在院方组织区块链网络上，公链服务读取院方记录在区块链网络上的数据，并将数据返回到客户端，客户端获取到的数据不包括加密处理过的ID值。如果查询多媒体文件数据，则院方组织服务器向文件系统服务器提交数据查询申请，将对应的数据传输至医务人员客户端。医务人员对于院方组织的数据读取不写入公链的查询记录链。

#### 院方读取普通用户数据

医务人员登录客户端，通过客户端提请数据查询的申请，默认查询主要数据，客户端将数据查询申请提交到院方组织服务器，在此过程中，传输的数据包括用户的ID。公链服务首先校验客户端账号对应的院方节点当前状态，校验后用户的ID经过公链服务的查找计算为对应的用户Hash ID，公链服务在对应的用户ID链上查询对应的普通用户组织信息，向查询到的用户组织服务器提交数据查询申请。用户组织服务器将用户的病例内容传输给院方服务器，由院方服务器传输给医务人员客户端，公链服务将本次查询的院方医务人员Hash ID、普通用户Hash ID以及病例查询的范围记录到公链的查询记录链中。如果院方需要读取用户的多媒体医疗数据，则医务人员登录客户端，客户端向院方服务器提交数据查询申请，公链服务首先校验院方医务人员对应节点的当前状态，校验后公链服务在用户ID链上查询普通用户组织，向对应的多媒体文件服务器请求数据，多媒体文件服务器将数据传输至院方人员客户端，最后公链服务将查询记录写入公链。医疗数据优先传输重要的摘要数据，然后按照时间由近及远的次序将主要数据传输，最后文件系统服务器传输多媒体文件医疗数据。

### 认证组织查询节点查询医疗数据

认证组织查询节点只能读取主要数据，不允许其读取多媒体文件医疗数据，进行读取时不进行验证校验操作。认证组织查询人员登录客户端，从客户端提交查询申请，客户端向公链服务提交查询申请，公链服务对该查询人员进行验证校验后，由各个普通用户服务器将该普通用户组织内的区块链网络上的数据进行读取传输到客户端，每个用户组织服务器仅读取传输一次数据，该部分数据不包括用户Hash ID，其标号将会根据其Hash ID和组织ID和查询时间的时间戳进行计算。最后公链服务将查询信息写入公链服务的查询记录链。

## 验证过程

### 数据验证

公链服务将读取到的医疗数据信息进行Hash计算，并与主链中对应的普通用户Hash链中的Hash值进行比较，确保被验证信息未被篡改，保证医疗数据的正确性。

### 账号验证

#### 普通用户账号

普通用户登录客户端时验证其账号、密码和登录证书。普通用户进行数据查询时，验证对应的普通用户节点下的区块链证书。

#### 院方医务人员账号

院方医务人员登录客户端时验证其账号、密码、登录证书和对应院方医务人员节点的当前状态。进行数据查询或写入时，首先验证院方医务人员的当前状态，然后进行数据查询或写入的申请。

#### 认证组织账号

认证组织人员登录客户端时验证其账号、密码、登录证书和对应认证组织节点的当前状态。进行数据查询或账号注册时，首先验证院方医务人员的当前状态，然后进行数据查询或账号注册的申请。

## 数据安全性

数据读取时数据仓库对读取人是封闭的：数据读取时，验证客户端和账号对应节点后，由公链服务进行数据的查询与验证，数据由节点服务器传输至公链服务器后传输至客户端。

院方和普通用户的数据是隔离开来的：院方组织和用户组织分别维护数据信息，降低数据被恶意破坏的风险。

数据有操作记录和验证信息：公链服务记录修改和查询情况，可以有效降低数据被篡改的风险。查询到的数据根据主链中的Hash数据进行验证，以确保信息的原始性。

## 数据共享性

院方组织内部数据通过区块链网络组织共享，各个院方组织间不建立数据共享的通道。院方组织可以在一定的条件下查询普通用户的数据，该数据是普通用户在的全部医院的医疗数据，达到治疗时数据共享的目的。认证组织查询节点可以读取到的数据只包括病例信息以供数据研究，不包括普通用户的个人信息。

## 数据读取效率和空间占用

为减少空间占用和提高读取效率，设计多链的结构。在比特币的区块链网络中采取的是公链，全部的交易信息存储在一条公共的区块链上，当交易数量庞大后，数据的容量也随之增大，读取的效率降低。由于比特币网络的交易数据内容和医疗数据相比要少很多，参与的人数也更少，所以到目前为止没有太大问题，且医疗数据需要相对高速的数据读取，因此多链设计更为合理。该服务采取院方组织和用户组织分别建立不同的区块链网络的方式，在每个独立的医院组织内部备份院方的数据，在一定数量的普通用户组织内进行数据备份，在公链服务器上只进行少量的普通用户ID、普通用户当前状态信息、院方Hash信息和查询写入记录，将不同的组织部署在多个服务器上，相对短的区块链信息存储可以加快信息的读取速率，分布式的组织访问也能有效减轻服务器的访问压力。公链的数据验证可以确保数据的原始性。